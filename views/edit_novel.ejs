<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤: <%= novel.title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <a href="/novel/<%= novel._id %>" class="btn btn-outline">
                <i class="fa-solid fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </a>
            <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</h2>
        </header>

        <div class="card">
            <form action="/novel/<%= novel._id %>?_method=PUT" method="POST">
                
                <div style="margin-bottom: 20px;">
                    <label><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (Title):</strong></label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="titleInput" name="title" value="<%= novel.title %>" required>
                        <button type="button" onclick="translateField('titleInput')" class="btn btn-warning" style="width: 150px;">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> ‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢
                        </button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label><strong>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠ (Description):</strong></label>
                    <div style="display: flex; gap: 10px; align-items: start;">
                        <textarea id="descInput" name="description" style="height: 100px;"><%= novel.description %></textarea>
                        <button type="button" onclick="translateField('descInput')" class="btn btn-warning" style="height: 100px;">
                            <i class="fa-solid fa-wand-magic-sparkles"></i>
                        </button>
                    </div>
                </div>

                <hr style="margin: 30px 0;">

                <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; border: 1px solid #b6d4fe; margin-bottom: 20px;">
                    <label style="color: #0d47a1;"><strong>ü§ñ AI Persona (‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•):</strong></label>
                    <textarea name="customPrompt" style="height: 80px; border: 1px solid #0d47a1;"><%= novel.customPrompt %></textarea>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffecb5;">
                    <label style="color: #856404;"><strong>üìñ ‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏î‡∏®‡∏±‡∏û‡∏ó‡πå / Glossary (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏ô‡∏µ‡πâ):</strong></label>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                        ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏∏‡∏Å‡∏ï‡∏≠‡∏ô (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ‡∏Ñ‡∏≥) <br>
                        ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <code>‡∏Ñ‡∏≥‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô = ‡∏Ñ‡∏≥‡πÑ‡∏ó‡∏¢</code>
                    </p>
                    <textarea name="glossary" placeholder="Tanaka = ‡∏ó‡∏≤‡∏ô‡∏≤‡∏Å‡∏∞&#10;Excalibur = ‡∏î‡∏≤‡∏ö‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πå‡∏Ñ‡∏≤‡∏•‡∏¥‡πÄ‡∏ö‡∏≠‡∏£‡πå&#10;Fireball = ‡∏ö‡∏≠‡∏•‡πÄ‡∏û‡∏•‡∏¥‡∏á" style="height: 150px; border: 1px solid #ffecb5; font-family: monospace;"><%= novel.glossary %></textarea>
                </div>

                <div style="margin-top: 30px; text-align: right;">
                    <button type="submit" class="btn">
                        <i class="fa-solid fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function translateField(elementId) {
            const input = document.getElementById(elementId);
            const originalText = input.value;
            if (!originalText) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏î‡πÅ‡∏õ‡∏•");
            
            const btn = event.currentTarget;
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                const res = await fetch('/api/translate-snippet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: originalText })
                });
                const data = await res.json();
                if (data.translatedText) input.value = data.translatedText;
            } catch (err) {
                alert("‡πÅ‡∏õ‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err);
            } finally {
                btn.innerHTML = originalIcon;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>