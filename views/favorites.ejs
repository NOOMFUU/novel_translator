<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô - Novel Library</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script> document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light'); </script>

    <style>
        /* CSS ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ (Inline ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏î‡∏ß‡∏Å) */
        .fav-header-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent, #a855f7) 100%);
            border-radius: var(--radius-card, 16px);
            padding: 30px;
            color: white;
            box-shadow: 0 10px 25px rgba(var(--primary-rgb, 99, 102, 241), 0.3);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .fav-header-bg {
            position: absolute;
            right: -20px; top: -30px;
            font-size: 10rem;
            opacity: 0.1;
            transform: rotate(15deg);
        }

        .fav-stats {
            display: inline-flex;
            gap: 20px;
            margin-top: 15px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 50px;
            backdrop-filter: blur(5px);
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (Overlay ‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î) */
        .remove-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 10;
            opacity: 0;
            transition: all 0.2s;
            transform: scale(0.8);
        }
        
        /* ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏ä‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î (Desktop) ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏•‡∏≠‡∏î‡πÉ‡∏ô Mobile */
        .novel-card:hover .remove-overlay {
            opacity: 1;
            transform: scale(1);
        }
        @media (max-width: 768px) {
            .remove-overlay { opacity: 1; transform: scale(1); }
        }

        .btn-remove {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9); /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 0.8rem;
        }
        .btn-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Empty State */
        .empty-state {
            background: var(--bg-glass);
            border: 1px dashed var(--border);
            border-radius: 16px;
            padding: 60px 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="container header-content">
            <a href="/" class="logo" style="text-decoration: none;">
                <i class="fa-solid fa-arrow-left"></i> 
                <span style="font-size: 1rem; font-weight: 600;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
            <div style="font-weight: 700; font-size: 1.1rem;">‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô üìö</div>
        </div>
    </header>

    <div class="container" style="padding-top: 30px;">
        
        <div class="fav-header-card">
            <i class="fa-solid fa-heart fav-header-bg"></i>
            <h1 style="margin: 0; font-size: 1.8rem; font-weight: 800;">My Collection</h1>
            <p style="margin: 5px 0 0 0; opacity: 0.9;">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì <strong><%= user.username %></strong></p>
            
            <div class="fav-stats">
                <span><i class="fa-solid fa-book-bookmark"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏¢‡∏π‡πà <strong><%= novels ? novels.length : 0 %></strong> ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
            </div>
        </div>

        <% if (!novels || novels.length === 0) { %>
            <div class="empty-state">
                <div style="width: 80px; height: 80px; background: var(--bg-input); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <i class="fa-solid fa-layer-group" style="font-size: 2.5rem; color: var(--text-muted); opacity: 0.5;"></i>
                </div>
                <h3 style="margin-bottom: 10px;">‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</h3>
                <p class="text-muted" style="margin-bottom: 25px;">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏î‡πÄ‡∏•‡∏¢</p>
                <a href="/" class="btn btn-primary">
                    <i class="fa-solid fa-compass"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏•‡∏¢
                </a>
            </div>
        <% } else { %>
            
            <div class="novel-grid">
                <% novels.forEach(novel => { %>
                    <div class="novel-card-wrapper" id="card-<%= novel._id %>" style="position: relative;">
                        <div class="remove-overlay">
                            <button onclick="removeFav(event, '<%= novel._id %>', '<%= novel.title %>')" class="btn-remove" title="‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>

                        <a href="/novel/<%= novel._id %>" class="novel-card">
                            <div class="cover-wrapper">
                                <% 
                                    let statusClass = 'status-on';
                                    let statusText = 'ON GOING';
                                    if(novel.status === 'Completed') { statusClass = 'status-end'; statusText = 'END'; }
                                    if(novel.status === 'Hiatus') { statusClass = 'status-hiatus'; statusText = 'HIATUS'; }
                                %>
                                <div class="status-badge <%= statusClass %>"><%= statusText %></div>
                                
                                <img src="<%= novel.imageUrl || defaultCover %>" 
                                     onerror="this.onerror=null;this.src='<%= defaultCover %>';"
                                     class="novel-cover" loading="lazy">
                            </div>
                            
                            <div class="novel-title"><%= novel.title %></div>
                            
                            <div class="novel-stats">
                                <span><i class="fa-regular fa-eye"></i> <%= (novel.views || 0).toLocaleString() %></span>
                                <% if(novel.categories && novel.categories.length > 0) { %>
                                    <span style="color:var(--primary); font-size:0.65rem; background:rgba(99,102,241,0.1); padding:2px 6px; border-radius:4px; font-weight:600;">
                                        <%= novel.categories[0] %>
                                    </span>
                                <% } %>
                            </div>
                        </a>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>

    <script>
        async function removeFav(event, novelId, title) {
            // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏õ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢
            event.preventDefault();
            event.stopPropagation();

            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á "${title}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠
            const btn = event.currentTarget;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (Toggle Logic ‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ remove ‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                const res = await fetch(`/novel/${novelId}/favorite`, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json' }
                });
                const data = await res.json();

                if (data.success && !data.isFav) { // isFav = false ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏î‡πâ‡∏ß‡∏¢ Animation
                    const card = document.getElementById(`card-${novelId}`);
                    card.style.transition = 'all 0.3s';
                    card.style.transform = 'scale(0.8)';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();
                        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå Empty State
                        const remaining = document.querySelectorAll('.novel-card-wrapper');
                        if (remaining.length === 0) location.reload();
                    }, 300);
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                    btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                }
            } catch (err) {
                console.error(err);
                alert('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
            }
        }
    </script>
</body>
</html>