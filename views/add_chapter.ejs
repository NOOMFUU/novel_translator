<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เพิ่มตอนใหม่: <%= novel.title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script> document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light'); </script>
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <header class="main-header">
        <div class="container d-flex justify-between align-center w-100">
            <div class="d-flex align-center gap-2">
                <a href="/novel/<%= novel._id %>" class="btn btn-outline btn-sm" style="border:none;"><i class="fa-solid fa-arrow-left"></i></a>
                <div><div class="text-muted" style="font-size: 0.8rem;">เพิ่มตอนใหม่</div><div style="font-weight: 700;"><%= novel.title %></div></div>
            </div>
        </div>
    </header>

    <div class="container" style="max-width: 900px; padding-top: 30px;">
        <div class="card">
            <form id="form-manual" onsubmit="handleSubmit(event)">
                
                <div style="background: rgba(var(--primary-rgb), 0.05); border: 1px dashed var(--primary); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                    <label style="color: var(--primary); font-weight: 600; display: block; margin-bottom: 8px;">
                        <i class="fa-solid fa-bolt"></i> Smart Paste (วางเนื้อหาเพื่อแยกชื่อตอนอัตโนมัติ)
                    </label>
                    <textarea id="smartPasteInput" class="modern-textarea" style="border:none; background:transparent; min-height:80px;" placeholder="เช่น: ตอนที่ 10 การเริ่มต้นใหม่ ... (วางเนื้อหา)" oninput="detectHeader()"></textarea>
                </div>

                <div class="d-flex gap-3 mb-4 flex-wrap">
                    <div style="flex: 0 0 120px;">
                        <label class="form-label">ลำดับ (Ep)</label>
                        <input type="number" step="0.1" id="manualChapterNumber" name="manualChapterNumber" value="<%= nextChapterNumber %>" class="modern-input" required>
                    </div>
                    <div style="flex: 1;">
                        <label class="form-label">ชื่อตอน</label>
                        <input type="text" id="manualTitle" name="manualTitle" class="modern-input" required>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label">เนื้อหา</label>
                    <textarea id="manualTranslated" name="manualTranslated" class="modern-textarea" style="height: 450px; font-family: 'Sarabun', sans-serif;" required placeholder="พิมพ์เนื้อหานิยายที่นี่..."></textarea>
                </div>

                <div class="d-flex justify-between align-center pt-4" style="border-top: 1px solid var(--border);">
                    <button type="button" class="btn btn-outline" onclick="document.getElementById('form-manual').reset()"><i class="fa-solid fa-eraser"></i> ล้าง</button>
                    <button type="submit" class="btn btn-primary btn-lg" id="btn-submit"><i class="fa-solid fa-save"></i> บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const novelId = "<%= novel._id %>";
        let nextChapterNum = parseFloat("<%= nextChapterNumber %>");

        // [เพิ่ม] ฟังก์ชัน showToast
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
            
            toast.innerHTML = `
                <i class="fa-solid ${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);

            // Auto remove
            setTimeout(() => {
                toast.style.animation = 'toastFadeOut 0.4s forwards';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        async function handleSubmit(e) {
            e.preventDefault();
        
            const btn = document.getElementById('btn-submit');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> กำลังบันทึก...';
            btn.disabled = true;

            const formData = new FormData(e.target);
            try {
                const res = await fetch(`/novel/${novelId}/chapters`, { method: 'POST', body: formData, headers: {'Accept': 'application/json'} });
                const result = await res.json();
                
                if(result.success) {
                    // [แก้ไข] เปลี่ยนจาก alert เป็น showToast
                    showToast('บันทึกตอนใหม่เรียบร้อยแล้ว!', 'success');
                    
                    document.getElementById('form-manual').reset();
                    nextChapterNum = parseFloat(result.chapter.chapterNumber) + 1;
                    document.getElementById('manualChapterNumber').value = nextChapterNum;
                } else { 
                    throw new Error(result.message);
                }
            } catch(err) { 
                // [แก้ไข] เปลี่ยนจาก alert เป็น showToast
                showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
            }
            finally { 
                btn.innerHTML = originalText; 
                btn.disabled = false;
            }
        }

        function detectHeader() {
            const input = document.getElementById('smartPasteInput').value;
            if (!input.trim()) return;
            const lines = input.split('\n');
            const firstLine = lines[0].trim();
            const match = firstLine.match(/^(?:ตอนที่|บทที่|Chapter|Ep\.?|Episode|第)?\s*(\d+(\.\d+)?)\s*[:：.\s-]?\s*(.*)$/i);
            if (match) {
                document.getElementById('manualChapterNumber').value = match[1];
                document.getElementById('manualTitle').value = match[3] ? `ตอนที่ ${match[1]} : ${match[3]}` : `ตอนที่ ${match[1]}`;
                document.getElementById('manualTranslated').value = lines.slice(1).join('\n').trim();
            } else {
                document.getElementById('manualTitle').value = firstLine;
                document.getElementById('manualTranslated').value = lines.slice(1).join('\n').trim();
            }
        }
    </script>
</body>
</html>