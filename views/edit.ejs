<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit: <%= chapter.title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="toast-container" class="toast-container"></div>
    <div class="container" style="padding: 20px 0;">
        <header class="d-flex justify-between align-center mb-4">
            <h2 style="margin:0;">แก้ไขตอน</h2>
            <div style="display: flex; gap: 10px;">
                <a href="/chapter/<%= chapter._id %>" class="btn btn-outline">ยกเลิก</a>
                <form action="/chapter/<%= chapter._id %>?_method=DELETE" method="POST" onsubmit="return confirm('ยืนยันการลบตอนนี้?')" style="margin:0;">
                    <button type="submit" class="btn btn-outline" style="color: var(--danger); border-color: var(--danger);"><i class="fa-solid fa-trash"></i></button>
                </form>
                <button onclick="saveChapter()" class="btn btn-primary"><i class="fa-solid fa-save"></i> บันทึก</button>
            </div>
        </header>

        <form id="editForm" class="glass-panel">
            <div class="d-flex gap-2 mb-4">
                <div style="flex: 1;">
                    <label class="text-muted">ลำดับตอน</label>
                    <input type="number" step="0.1" name="chapterNumber" value="<%= chapter.chapterNumber %>" required>
                </div>
                <div style="flex: 4;">
                    <label class="text-muted">ชื่อตอน</label>
                    <input type="text" name="title" value="<%= chapter.title %>" required>
                </div>
            </div>

            <div class="split-pane">
                <div style="display: flex; flex-direction: column;">
                    <label class="text-muted">Editor (HTML Supported)</label>
                    <textarea id="editor" name="translatedContent" style="flex: 1; font-family: monospace; resize: none; border-radius: var(--radius-sm); padding: 15px;" oninput="updatePreview()"><%= chapter.translatedContent %></textarea>
                </div>
                <div style="display: flex; flex-direction: column;">
                    <label class="text-muted">Live Preview</label>
                    <div id="preview" class="preview-box" style="flex: 1;"></div>
                </div>
            </div>
        </form>
    </div>

    <script>
        const chapterId = "<%= chapter._id %>";
        
        function updatePreview() {
            const content = document.getElementById('editor').value;
            document.getElementById('preview').innerHTML = content.replace(/\n/g, '<br>');
        }

        async function saveChapter() {
            const form = document.getElementById('editForm');
            const formData = new URLSearchParams(new FormData(form));

            try {
                const res = await fetch(`/chapter/${chapterId}?_method=PUT`, {
                    method: 'POST',
                    body: formData,
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Accept': 'application/json' }
                });
                const result = await res.json();
                if(result.success) showToast('บันทึกสำเร็จ!');
            } catch(e) {
                showToast('เกิดข้อผิดพลาด', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
        updatePreview();
    </script>
</body>
</html>