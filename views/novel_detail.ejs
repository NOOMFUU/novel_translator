<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= novel.title %> - จัดการ</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Grid View */
        .chapter-container.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            padding: 15px;
        }
        .chapter-container.grid-view .chapter-item {
            flex-direction: column;
            align-items: flex-start;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            height: 100%;
            background: var(--bg-card);
            justify-content: space-between;
            position: relative; /* สำหรับปุ่ม Read Toggle */
        }
        .chapter-container.grid-view .chapter-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }
        .chapter-container.grid-view .chapter-link {
            flex-direction: column;
            align-items: flex-start; gap: 5px; width: 100%;
        }
        .chapter-container.grid-view .chapter-tag { margin-bottom: 5px; }

        /* Style สำหรับตอนที่อ่านแล้ว */
        .chapter-item.is-read {
            opacity: 0.6;
            background-color: var(--bg-body); /* สีพื้นหลังจางลง */
            border-color: transparent;
        }
        .chapter-item.is-read:hover {
            opacity: 1; /* เมาส์ชี้แล้วชัดขึ้น */
            border-color: var(--primary);
        }
        .chapter-item.is-read .chapter-link {
            color: var(--text-muted);
        }
        
        /* ปุ่มดวงตา (Toggle Read) */
        .read-toggle-btn {
            background: none; border: none; cursor: pointer;
            color: var(--text-muted); font-size: 1.1em;
            padding: 5px; border-radius: 50%; transition: 0.2s;
        }
        .read-toggle-btn:hover { color: var(--primary); background: var(--bg-body); }
        .chapter-item.is-read .read-toggle-btn { color: var(--success, green); }


        /* Toolbar */
        .view-controls {
            display: flex;
            justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 10px; background: var(--bg-card);
            border: 1px solid var(--border); border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:999; flex-direction:column; justify-content:center; align-items:center; color:white;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size: 3em; margin-bottom: 20px;"></i>
        <h3>AI กำลังแปล...</h3>
    </div>

    <header class="main-header">
        <div class="container header-content">
            <div class="d-flex align-center">
                <a href="/" class="btn-icon" style="margin-right: 15px;"><i class="fa-solid fa-arrow-left"></i></a>
                <div class="logo"><i class="fa-solid fa-book-open-reader"></i> Novel Translator</div>
            </div>
            <button onclick="toggleTheme()" class="btn btn-outline btn-sm"><i class="fa-solid fa-moon"></i></button>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="d-flex justify-between" style="flex-wrap: wrap; gap: 20px;">
                <div style="flex: 1; min-width: 300px;">
                    <h1 class="novel-title-large"><%= novel.title %></h1>
                    <div class="novel-desc-box">
                        <strong><i class="fa-regular fa-file-lines"></i> เรื่องย่อ:</strong><br>
                        <%= novel.description || "ไม่มีเรื่องย่อ" %>
                    </div>
                    <div class="text-muted">
                        <span><i class="fa-solid fa-list-ol"></i> <%= chapters.length %> ตอน</span> | 
                        <span><i class="fa-regular fa-calendar"></i> <%= new Date(novel.createdAt).toLocaleDateString('th-TH') %></span>
                    </div>
                </div>
                <div class="novel-header-actions" style="align-self: flex-start;">
                    <a href="/novel/<%= novel._id %>/edit" class="btn btn-outline"><i class="fa-solid fa-gear"></i> ตั้งค่า</a>
                    <form action="/novel/<%= novel._id %>?_method=DELETE" method="POST" onsubmit="return confirm('⚠️ ลบเรื่องนี้?');">
                        <button type="submit" class="btn btn-danger"><i class="fa-solid fa-trash-can"></i> ลบ</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <button id="tabBtnAuto" class="tab-btn active" onclick="switchTab('auto')">✨ AI Translate</button>
                <button id="tabBtnManual" class="tab-btn" onclick="switchTab('manual')">✍️ Manual</button>
            </div>
            
            <form id="form-auto" action="/novel/<%= novel._id %>/chapters" method="POST" onsubmit="showLoading()">
                <input type="hidden" name="mode" value="auto">
                <div class="form-group">
                    <textarea name="rawText" placeholder="วางเนื้อหาภาษาญี่ปุ่น..." style="height: 100px;" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">แปลและเพิ่มตอน</button>
            </form>

            <form id="form-manual" action="/novel/<%= novel._id %>/chapters" method="POST" style="display:none;">
                <input type="hidden" name="mode" value="manual">
                <div class="form-group" style="background: var(--primary-light); padding: 10px; border-radius: 8px;">
                    <label style="color:var(--primary); font-size:0.9em;">Smart Paste:</label>
                    <textarea id="smartPasteInput" style="height: 80px;" oninput="detectHeader()"></textarea>
                </div>
                <div class="d-flex gap-2 mb-2">
                    <input type="number" step="0.1" id="manualChapterNumber" name="manualChapterNumber" placeholder="เลขตอน" style="width: 80px;">
                    <input type="text" id="manualTitle" name="manualTitle" placeholder="ชื่อตอน">
                </div>
                <textarea id="manualTranslated" name="manualTranslated" style="height: 200px;" required></textarea>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top:10px;">บันทึก</button>
            </form>
        </div>

        <h3 class="mt-4"><i class="fa-solid fa-list"></i> สารบัญ</h3>
        <div class="view-controls">
            <div>
                <button class="btn btn-sm btn-outline active" id="btnSortDesc" onclick="sortChapters('desc')"><i class="fa-solid fa-arrow-down-9-1"></i> ล่าสุด</button>
                <button class="btn btn-sm btn-outline" id="btnSortAsc" onclick="sortChapters('asc')"><i class="fa-solid fa-arrow-up-1-9"></i> เก่าสุด</button>
            </div>
            <div>
                <button class="btn btn-sm btn-outline active" id="btnList" onclick="setView('list')"><i class="fa-solid fa-list"></i> รายการ</button>
                <button class="btn btn-sm btn-outline" id="btnGrid" onclick="setView('grid')"><i class="fa-solid fa-border-all"></i> ตาราง</button>
            </div>
        </div>

        <div class="card" style="padding: 0; overflow: hidden;">
            <div id="chapterContainer" class="chapter-list">
                <% chapters.forEach(chapter => { %>
                    <div class="chapter-item" id="chapter-<%= chapter._id %>" data-number="<%= chapter.chapterNumber %>">
                        <div class="d-flex align-center" style="flex:1;">
                            <a href="/chapter/<%= chapter._id %>" class="chapter-link">
                                <span class="chapter-tag">#<%= chapter.chapterNumber %></span>
                                <span><%= chapter.title.replace(/^ตอนที่ \d+[:\s]*/, '') %></span>
                            </a>
                        </div>
                        
                        <div class="d-flex gap-2 align-center">
                            <button onclick="toggleReadItem('<%= chapter._id %>')" class="read-toggle-btn" title="ทำเครื่องหมายว่าอ่านแล้ว">
                                <i class="fa-regular fa-eye"></i>
                            </button>

                            <a href="/chapter/<%= chapter._id %>/edit" class="btn-icon"><i class="fa-solid fa-pen"></i></a>
                            <form action="/chapter/<%= chapter._id %>?_method=DELETE" method="POST" onsubmit="return confirm('ลบ?');" style="margin:0;">
                                <button type="submit" class="btn-icon" style="color: var(--danger);"><i class="fa-solid fa-trash"></i></button>
                            </form>
                        </div>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>

    <script>
        // Theme Logic
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
        function toggleTheme() {
            const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        // --- Read Status Logic ---
        function getReadChapters() {
            return JSON.parse(localStorage.getItem('read_chapters') || '[]');
        }

        function saveReadChapters(list) {
            localStorage.setItem('read_chapters', JSON.stringify(list));
            renderReadStatus();
        }

        function toggleReadItem(id) {
            let list = getReadChapters();
            if (list.includes(id)) {
                list = list.filter(item => item !== id);
            } else {
                list.push(id);
            }
            saveReadChapters(list);
        }

        function renderReadStatus() {
            const list = getReadChapters();
            document.querySelectorAll('.chapter-item').forEach(item => {
                const id = item.id.replace('chapter-', '');
                const icon = item.querySelector('.read-toggle-btn i');
                
                if (list.includes(id)) {
                    item.classList.add('is-read');
                    if(icon) {
                        icon.className = 'fa-solid fa-check'; // เปลี่ยนเป็นเครื่องหมายถูก
                    }
                } else {
                    item.classList.remove('is-read');
                    if(icon) {
                        icon.className = 'fa-regular fa-eye'; // เปลี่ยนเป็นรูปตา
                    }
                }
            });
        }

        // --- Init Function ---
        document.addEventListener('DOMContentLoaded', () => {
            // Restore View & Tab
            const savedView = localStorage.getItem('viewMode') || 'list';
            setView(savedView);
            sortChapters('desc');
            const savedTab = localStorage.getItem('activeTab') || 'auto';
            switchTab(savedTab);

            // Render Read Status
            renderReadStatus();
        });

        // View & Sort Logic
        function setView(view) {
            const container = document.getElementById('chapterContainer');
            const btnList = document.getElementById('btnList');
            const btnGrid = document.getElementById('btnGrid');

            if (view === 'grid') {
                container.classList.remove('chapter-list');
                container.classList.add('chapter-container', 'grid-view');
                btnGrid.classList.add('active'); btnList.classList.remove('active');
            } else {
                container.classList.remove('chapter-container', 'grid-view');
                container.classList.add('chapter-list');
                btnList.classList.add('active'); btnGrid.classList.remove('active');
            }
            localStorage.setItem('viewMode', view);
        }

        function sortChapters(order) {
            const container = document.getElementById('chapterContainer');
            const items = Array.from(container.children);
            items.sort((a, b) => {
                const numA = parseFloat(a.getAttribute('data-number'));
                const numB = parseFloat(b.getAttribute('data-number'));
                return order === 'asc' ? numA - numB : numB - numA;
            });
            container.innerHTML = '';
            items.forEach(item => container.appendChild(item));
            
            document.getElementById('btnSortAsc').classList.toggle('active', order === 'asc');
            document.getElementById('btnSortDesc').classList.toggle('active', order === 'desc');
        }

        // Tab Logic (บันทึก Tab เดิม)
        function switchTab(mode) {
            localStorage.setItem('activeTab', mode);
            document.getElementById('form-auto').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('form-manual').style.display = mode === 'manual' ? 'block' : 'none';
            const btnAuto = document.getElementById('tabBtnAuto');
            const btnManual = document.getElementById('tabBtnManual');

            if (mode === 'auto') {
                btnAuto.classList.add('active');
                btnManual.classList.remove('active');
            } else {
                btnAuto.classList.remove('active');
                btnManual.classList.add('active');
            }
        }

        function showLoading() { 
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function detectHeader() {
            const input = document.getElementById('smartPasteInput').value;
            if (!input.trim()) return;
            const lines = input.split('\n');
            const match = lines[0].trim().match(/^(?:ตอนที่|บทที่|Chapter|Ep|第)?\s*(\d+(\.\d+)?)\s*[話:：.\s]?\s*(.*)$/i);
            if (match) {
                document.getElementById('manualChapterNumber').value = match[1];
                document.getElementById('manualTitle').value = match[3];
                document.getElementById('manualTranslated').value = lines.slice(1).join('\n').trim();
            } else {
                document.getElementById('manualTitle').value = lines[0];
                document.getElementById('manualTranslated').value = lines.slice(1).join('\n').trim();
            }
        }
    </script>
</body>
</html>