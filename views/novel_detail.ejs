<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= novel.title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chapter-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px; background: var(--bg-body);
            border: 1px solid var(--border); border-radius: 6px;
            margin-bottom: 8px; transition: background 0.2s;
        }
        .chapter-list-item:hover { background: var(--bg-card); border-color: var(--accent); }
        .chapter-list-item.read { opacity: 0.6; }
        .chapter-list-item.read i.status-icon { color: var(--success); }
        
        .tab-btn {
            padding: 8px 16px; border: none; background: transparent;
            font-weight: 600; color: var(--text-muted); cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    </style>
</head>
<body>
    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; flex-direction:column; justify-content:center; align-items:center; color:var(--primary);">
        <i class="fa-solid fa-spinner fa-spin" style="font-size: 3em; margin-bottom: 20px;"></i>
        <h3>AI กำลังแปลภาษา...</h3>
    </div>

    <header class="main-header">
        <div class="container header-content">
            <div class="d-flex align-center gap-2">
                <a href="/" class="btn btn-outline btn-sm"><i class="fa-solid fa-arrow-left"></i> กลับ</a>
                <div class="logo" style="font-size: 1rem; color: var(--text-muted);"><%= novel.title %></div>
            </div>
            <button onclick="toggleTheme()" class="btn btn-outline btn-sm"><i class="fa-solid fa-moon"></i></button>
        </div>
    </header>

    <div class="container" style="padding-top: 30px;">
        <div class="card">
            <div class="d-flex justify-between" style="flex-wrap: wrap; gap: 30px;">
                <div style="flex: 1; min-width: 300px;">
                    <h1 style="font-size: 1.8rem; margin-bottom: 10px; color: var(--primary);"><%= novel.title %></h1>
                    <div style="background: var(--bg-body); padding: 15px; border-radius: 6px; margin-bottom: 20px; font-size: 0.95rem; color: var(--text-muted);">
                        <%= novel.description || "ไม่มีคำอธิบาย" %>
                    </div>
                    <div class="text-muted d-flex gap-2 align-center" style="font-size: 0.9rem;">
                        <span><i class="fa-solid fa-list-ol"></i> <%= chapters.length %> ตอน</span>
                        <span>|</span>
                        <span><i class="fa-regular fa-calendar"></i> <%= new Date(novel.createdAt).toLocaleDateString('th-TH') %></span>
                    </div>
                </div>
                
                <% if (isAdmin) { %>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <a href="/novel/<%= novel._id %>/edit" class="btn btn-outline"><i class="fa-solid fa-sliders"></i> ตั้งค่า</a>
                    <form action="/novel/<%= novel._id %>?_method=DELETE" method="POST" onsubmit="return confirm('ยืนยันลบเรื่องนี้?');">
                        <button type="submit" class="btn btn-danger" style="width:100%;"><i class="fa-solid fa-trash"></i> ลบเรื่อง</button>
                    </form>
                </div>
                <% } %>
            </div>
        </div>

        <% if (isAdmin) { %>
        <div class="card">
            <div style="border-bottom: 1px solid var(--border); margin-bottom: 20px; display: flex;">
                <button id="tabBtnAuto" class="tab-btn active" onclick="switchTab('auto')">✨ AI แปลอัตโนมัติ</button>
                <button id="tabBtnManual" class="tab-btn" onclick="switchTab('manual')">✍️ ลงเอง</button>
            </div>
            
            <form id="form-auto" action="/novel/<%= novel._id %>/chapters" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                <input type="hidden" name="mode" value="auto">
                
                <div style="margin-bottom: 15px; display: flex; gap: 20px;">
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="inputType" value="text" checked onclick="toggleInput('text')"> วางข้อความ
                    </label>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="inputType" value="file" onclick="toggleInput('file')"> อัปโหลดไฟล์ .txt
                    </label>
                </div>

                <div id="input-text-group">
                    <textarea name="rawText" placeholder="วางเนื้อหาภาษาญี่ปุ่นที่นี่..." style="height: 150px;"></textarea>
                </div>

                <div id="input-file-group" style="display: none;">
                    <div style="border: 2px dashed var(--border); background: var(--bg-body); padding: 30px; text-align: center; border-radius: 6px;">
                        <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2em; color: var(--text-muted); margin-bottom: 10px;"></i><br>
                        <input type="file" name="txtFile" accept=".txt" style="display: block; margin: 0 auto;">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 15px;">แปลและเพิ่มตอน</button>
            </form>

            <form id="form-manual" action="/novel/<%= novel._id %>/chapters" method="POST" style="display:none;">
                <input type="hidden" name="mode" value="manual">
                <div class="mb-4" style="background: var(--bg-body); padding: 15px; border-radius: 6px;">
                    <label style="color:var(--text-main); font-weight:bold;">Smart Paste (วางแล้วแกะหัวข้ออัตโนมัติ):</label>
                    <textarea id="smartPasteInput" style="height: 60px; margin-top:5px;" oninput="detectHeader()" placeholder="วาง Title + เนื้อหา..."></textarea>
                </div>
                <div class="d-flex gap-2 mb-4">
                    <input type="number" step="0.1" id="manualChapterNumber" name="manualChapterNumber" placeholder="เลขตอน" style="width: 100px;">
                    <input type="text" id="manualTitle" name="manualTitle" placeholder="ชื่อตอน (ไม่บังคับ)" style="flex:1;">
                </div>
                <textarea id="manualTranslated" name="manualTranslated" style="height: 200px;" placeholder="เนื้อหาภาษาไทย..." required></textarea>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top:15px;">บันทึก</button>
            </form>
        </div>
        <% } %>

        <div class="d-flex justify-between align-center mb-4">
            <h3><i class="fa-solid fa-list-ul"></i> สารบัญ</h3>
            <button class="btn btn-sm btn-outline" onclick="reverseSort()"><i class="fa-solid fa-sort"></i> เรียงใหม่</button>
        </div>

        <div id="chapterContainer">
            <% chapters.forEach(chapter => { %>
                <div class="chapter-list-item" id="chapter-<%= chapter._id %>">
                    <a href="/chapter/<%= chapter._id %>" style="text-decoration: none; color: inherit; flex: 1; display: flex; align-items: center; gap: 15px;">
                        <span style="background: var(--bg-body); color: var(--text-muted); padding: 2px 8px; border:1px solid var(--border); border-radius: 4px; font-weight: 600; font-size: 0.8rem;">#<%= chapter.chapterNumber %></span>
                        <span style="font-weight: 500;"><%= chapter.title.replace(/^ตอนที่ \d+[:\s]*/, '') %></span>
                    </a>
                    <div class="d-flex gap-2 align-center">
                        <i class="fa-regular fa-circle status-icon" style="color: var(--border); font-size: 1em;"></i>
                        <% if (isAdmin) { %>
                            <a href="/chapter/<%= chapter._id %>/edit" class="btn-sm btn-outline" style="border:none;"><i class="fa-solid fa-pen"></i></a>
                            <form action="/chapter/<%= chapter._id %>?_method=DELETE" method="POST" onsubmit="return confirm('ยืนยันลบ?');" style="margin:0;">
                                <button type="submit" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                            </form>
                        <% } %>
                    </div>
                </div>
            <% }) %>
        </div>
    </div>

    <script>
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');
        function toggleTheme() {
            const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
        
        function switchTab(mode) {
            document.getElementById('form-auto').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('form-manual').style.display = mode === 'manual' ? 'block' : 'none';
            document.getElementById('tabBtnAuto').classList.toggle('active', mode === 'auto');
            document.getElementById('tabBtnManual').classList.toggle('active', mode === 'manual');
        }

        function toggleInput(type) {
            if (type === 'text') {
                document.getElementById('input-text-group').style.display = 'block';
                document.getElementById('input-file-group').style.display = 'none';
            } else {
                document.getElementById('input-text-group').style.display = 'none';
                document.getElementById('input-file-group').style.display = 'block';
            }
        }

        function detectHeader() {
            const input = document.getElementById('smartPasteInput').value;
            if (!input.trim()) return;
            const lines = input.split('\n');
            const match = lines[0].trim().match(/^(?:ตอนที่|บทที่|Chapter|Ep|第)?\s*(\d+(\.\d+)?)\s*[話:：.\s]?\s*(.*)$/i);
            if (match) {
                document.getElementById('manualChapterNumber').value = match[1];
                document.getElementById('manualTitle').value = match[3];
                document.getElementById('manualTranslated').value = lines.slice(1).join('\n').trim();
            } else {
                document.getElementById('manualTitle').value = lines[0];
                document.getElementById('manualTranslated').value = lines.slice(1).join('\n').trim();
            }
        }

        function reverseSort() {
            const container = document.getElementById('chapterContainer');
            const items = Array.from(container.children);
            items.reverse().forEach(item => container.appendChild(item));
        }

        // Check Read Status
        const readList = JSON.parse(localStorage.getItem('read_chapters') || '[]');
        document.querySelectorAll('.chapter-list-item').forEach(item => {
            const id = item.id.replace('chapter-', '');
            if(readList.includes(id)) {
                item.classList.add('read');
                item.querySelector('.status-icon').classList.replace('fa-circle', 'fa-circle-check');
            }
        });
    </script>
</body>
</html>